<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Registry - Secure Pro</title>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<link rel="apple-touch-icon" href="icon2.png">
  <script src="dexie.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #121212; color: #e0e0e0; user-select: none; -webkit-user-select: none; }
        .screen { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; padding-bottom: 80px; }
        .active-screen { display: block; }
        .box { max-width: 450px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border: 1px solid #333; }
        
        h2, h3 { color: #a0cfff; margin-top: 0; text-align: center; }
        .stats { text-align: center; font-size: 14px; color: #888; margin-bottom: 20px; background: #252525; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        
        video { width: 100%; border-radius: 8px; background: #000; margin-bottom: 10px; min-height: 250px; border: 1px solid #444; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #444; border-radius: 6px; box-sizing: border-box; background: #2c2c2c; color: white; font-size: 16px; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 12px; transition: 0.2s; font-size: 14px; }
        button:active { transform: scale(0.96); }
        
        .btn-blue { background: #4a90e2; color: white; }
        .btn-gray { background: #444; color: white; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-red { background: #b71c1c; color: white; }
        .btn-back { background: #333; color: #a0cfff; border: 1px solid #444; margin-bottom: 20px; width: auto; padding: 10px 20px; }
        
        #galleryGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .gallery-item { width: 100%; aspect-ratio: 1; border-radius: 8px; object-fit: cover; border: 1px solid #444; cursor: pointer; }
        
        .viewer-container { margin-top: 20px; padding: 15px; background: #252525; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .view-img { width: 100%; border-radius: 6px; margin-top: 10px; margin-bottom: 15px; }

        #optionsMenu { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; justify-content: center; align-items: center; }
        .menu-box { width: 85%; max-width: 320px; background: #2c2c2c; padding: 25px; border-radius: 15px; border: 1px solid #4a90e2; text-align: center; }

        #customAlert { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 6000; justify-content: center; align-items: center; }
        .alert-content { background: #2c2c2c; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; border: 1px solid #a0cfff; }

        #lockScreen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; }

        .legal-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #000; color: #a0cfff; padding: 10px 0; font-size: 12px; font-weight: bold; border-top: 1px solid #444; z-index: 3000; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="lockScreen">
    <h2 style="color: #ff5252;">SUBSCRIPTION EXPIRED</h2>
    <p>Please enter this month's activation key.</p>
    <p style="font-size: 12px; color: #888;"> WhatsApp the developer for the code at +256754010923</p>
    <input type="text" id="monthKeyInput"  style="text-align: center; text-transform: uppercase;">
    <button class="btn-blue" onclick="validateMonthKey()">Activate Access</button>
</div>

<div id="optionsMenu">
    <div class="menu-box">
        <h3 id="menuTitle">Options</h3>
        <button class="btn-blue" id="optRename">‚úèÔ∏è Rename</button>
        <button class="btn-blue" id="optDownload">üì• Download</button>
        <button class="btn-green" id="optShare">üì§ Share</button>
        <button class="btn-red" id="optDelete">üóëÔ∏è Delete</button>
        <button class="btn-gray" id="optClose">‚ùå Close</button>
    </div>
</div>

<div id="customAlert">
    <div class="alert-content">
        <p id="alertMsg"></p>
        <div id="customInputArea" style="display:none;"><input type="text" id="uiTextInput"></div>
        <div id="uiButtons"><button class="btn-blue" id="alertBtn">OK</button></div>
        <div id="confirmGroup" style="display:none; gap:10px;">
            <button class="btn-blue" id="confirmYes">Confirm</button>
            <button class="btn-gray" id="confirmNo">Cancel</button>
        </div>
    </div>
</div>

<div id="scrMain" class="screen active-screen">
    <div class="box">
        <h2>Business Registry</h2>
        <div class="stats" id="dbCount">Records: 0</div>
        <button class="btn-blue" onclick="showScreen('scrCamera')">üì∏ Camera Capture</button>
        <button class="btn-green" onclick="showScreen('scrUpload')">üìÅ Upload Image</button>
        <button class="btn-gray" onclick="showScreen('scrSearch')">üîç Search Records</button>
        <button class="btn-gray" onclick="showScreen('scrGallery')">üñºÔ∏è View Gallery</button>
        <button class="btn-gray" onclick="showScreen('scrAdmin')">‚öôÔ∏è Settings</button>
    </div>
</div>

<div id="scrCamera" class="screen">
    <button class="btn-back" onclick="showScreen('scrMain')">‚Üê Back</button>
    <div class="box">
        <h3>Camera Capture</h3>
        <input type="text" id="camName" placeholder="Full Name & details">
        <video id="v" autoplay playsinline muted></video>
        <button class="btn-blue" onclick="startCamera()">Start Camera</button>
        <button class="btn-green" id="btnCaptureSave">Capture & Save</button>
    </div>
</div>

<div id="scrUpload" class="screen">
    <button class="btn-back" onclick="showScreen('scrMain')">‚Üê Back</button>
    <div class="box">
        <h3>Upload Record</h3>
        <input type="text" id="upName" placeholder="Full Name & details">
        <input type="file" id="filePicker" accept="image/*" style="display:none">
        <button class="btn-green" onclick="document.getElementById('filePicker').click()">Pick Image</button>
        <p id="upFileName" style="text-align:center; font-size:12px; color:#888;"></p>
        <button class="btn-blue" id="btnSaveUpload" style="display:none;">Save Upload</button>
    </div>
</div>

<div id="scrSearch" class="screen">
    <button class="btn-back" onclick="showScreen('scrMain')">‚Üê Back</button>
    <div class="box">
        <h3>Search</h3>
        <input type="text" id="searchQuery" list="nameList" placeholder="Search name...">
        <datalist id="nameList"></datalist>
        <button class="btn-blue" id="btnSearch">Find Record</button>
        <div id="searchResult" class="viewer-container" style="display:none;"></div>
    </div>
</div>

<div id="scrGallery" class="screen">
    <button class="btn-back" onclick="showScreen('scrMain')">‚Üê Back</button>
    <div class="box">
        <h3>Gallery</h3>
        <div id="galleryGrid"></div>
        <div id="galleryViewer" class="viewer-container" style="display:none;"></div>
    </div>
</div>

<div id="scrAdmin" class="screen">
    <button class="btn-back" onclick="showScreen('scrMain')">‚Üê Back</button>
    <div class="box">
        <h3>Admin Tools</h3>
        <button class="btn-gray" id="btnExport">Export Data (JSON)</button>
        <button class="btn-gray" onclick="document.getElementById('fileImport').click()">Combine Data</button>
        <input type="file" id="fileImport" style="display:none" accept=".json">
    </div>
</div>

<div class="legal-footer">
    <marquee></marquee>
</div>

<script>
    let db, activeRecord = null, uploadedData = null;

    // --- SHORT KEY PERPETUAL LOGIC ---
    function getExpectedKey() {
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const d = new Date();
        const shortMonth = months[d.getMonth()];
        const shortYear = d.getFullYear().toString().substr(-2); // Gets '26' or '27'
        return shortMonth + shortYear; // e.g., "FEB26"
    }

    function checkSubscription() {
        const expected = getExpectedKey();
        const saved = localStorage.getItem("monthly_active_key");
        if (saved !== expected) {
            document.getElementById('lockScreen').style.display = 'flex';
        }
    }

    function validateMonthKey() {
        const input = document.getElementById('monthKeyInput').value.trim().toUpperCase();
        const expected = getExpectedKey();
        if (input === expected) {
            localStorage.setItem("monthly_active_key", input);
            document.getElementById('lockScreen').style.display = 'none';
            showUI("Success: Access Granted for " + expected);
        } else {
            showUI("Invalid Key. Contact +256764010923");
        }
    }

    window.onload = checkSubscription;

    // --- NAVIGATION ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
        document.getElementById(id).classList.add('active-screen');
        if(id === 'scrGallery') {
            document.getElementById('galleryViewer').style.display = "none";
            document.getElementById('galleryGrid').style.display = "grid";
            loadGallery();
        }
        if(id !== 'scrCamera') stopCamera();
    }

    // --- CUSTOM UI (NO PASSWORDS) ---
    function showUI(msg, mode = 'alert') {
        return new Promise((resolve) => {
            const ui = document.getElementById('customAlert');
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('customInputArea').style.display = (mode === 'prompt') ? "block" : "none";
            document.getElementById('uiButtons').style.display = (mode === 'alert') ? "block" : "none";
            document.getElementById('confirmGroup').style.display = (mode !== 'alert') ? "flex" : "none";
            ui.style.display = "flex";

            document.getElementById('alertBtn').onclick = () => { ui.style.display = "none"; resolve(true); };
            document.getElementById('confirmNo').onclick = () => { ui.style.display = "none"; resolve(null); };
            document.getElementById('confirmYes').onclick = () => {
                const val = (mode === 'prompt') ? document.getElementById('uiTextInput').value : true;
                ui.style.display = "none";
                resolve(val);
            };
        });
    }

    // --- DATABASE & ACTIONS ---
    const request = indexedDB.open("BusinessDB5", 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("students")) db.createObjectStore("students", { keyPath: "name" });
    };
    request.onsuccess = (e) => { db = e.target.result; updateUI(); };

    document.getElementById('btnSearch').onclick = () => {
        const q = document.getElementById('searchQuery').value.trim().toLowerCase();
        if(!q) return;
        db.transaction("students").objectStore("students").get(q).onsuccess = (e) => {
            const res = e.target.result;
            if (res) {
                const r = document.getElementById('searchResult');
                r.style.display = "block";
                r.innerHTML = `<p><strong>${q.toUpperCase()}</strong></p><img src="${res.photo}" class="view-img"><br><button class="btn-blue" onclick="openOptions('${q}','${res.photo}')">Options</button>`;
            } else { showUI("Record not found."); }
        };
    };

    function loadGallery() {
        const g = document.getElementById('galleryGrid'); g.innerHTML = "";
        db.transaction("students").objectStore("students").openCursor().onsuccess = (e) => {
            const cur = e.target.result;
            if (cur) {
                const n = cur.value.name, p = cur.value.photo;
                const img = document.createElement('img'); img.src = p; img.className = 'gallery-item';
                img.onclick = () => {
                    g.style.display = "none";
                    const v = document.getElementById('galleryViewer');
                    v.style.display = "block";
                    v.innerHTML = `<p><strong>${n.toUpperCase()}</strong></p><img src="${p}" class="view-img"><br><button class="btn-blue" onclick="openOptions('${n}','${p}')">Options</button>`;
                };
                g.appendChild(img); cur.continue();
            }
        };
    }

    function openOptions(n, p) { activeRecord = { name: n, photo: p }; document.getElementById('menuTitle').innerText = n.toUpperCase(); document.getElementById('optionsMenu').style.display = 'flex'; }

    document.getElementById('optClose').onclick = () => {
        document.getElementById('optionsMenu').style.display = 'none';
        document.getElementById('searchResult').style.display = "none";
        document.getElementById('galleryViewer').style.display = "none";
        document.getElementById('galleryGrid').style.display = "grid";
    };

    document.getElementById('optDelete').onclick = async () => {
        const conf = await showUI("Delete " + activeRecord.name.toUpperCase() + "?", 'confirm');
        if(conf) {
            db.transaction("students", "readwrite").objectStore("students").delete(activeRecord.name).oncomplete = () => {
                updateUI(); document.getElementById('optClose').click(); showUI("Deleted.");
            };
        }
    };

    document.getElementById('optRename').onclick = async () => {
        const newN = await showUI("New name:", 'prompt');
        if(newN) {
            const tx = db.transaction("students", "readwrite");
            const store = tx.objectStore("students");
            store.delete(activeRecord.name);
            store.put({ name: newN.toLowerCase(), photo: activeRecord.photo });
            tx.oncomplete = () => { updateUI(); document.getElementById('optClose').click(); showUI("Renamed!"); };
        }
    };

    document.getElementById('optDownload').onclick = () => {
        const a = document.createElement('a'); a.href = activeRecord.photo;
        a.download = activeRecord.name + ".jpg"; a.click();
    };

    document.getElementById('optShare').onclick = async () => {
        try {
            const blob = await (await fetch(activeRecord.photo)).blob();
            const file = new File([blob], activeRecord.name + ".jpg", {type:"image/jpeg"});
            if(navigator.share) await navigator.share({files: [file]});
        } catch(e) { showUI("Share failed."); }
    };

    // Camera, Save, and Update functions
    const v = document.getElementById('v');
    async function startCamera() {
        try { v.srcObject = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); } catch(e) { showUI("Camera error."); }
    }
    function stopCamera() { if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop()); }
    document.getElementById('btnCaptureSave').onclick = () => {
        const name = document.getElementById('camName').value.trim().toLowerCase();
        if(!name || !v.srcObject) return showUI("Missing data.");
        const canvas = document.createElement('canvas');
        canvas.width = 500; canvas.height = (v.videoHeight/v.videoWidth)*500;
        canvas.getContext('2d').drawImage(v, 0, 0, canvas.width, canvas.height);
        saveRecord(name, canvas.toDataURL('image/jpeg', 0.6));
    };

    document.getElementById('filePicker').onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => { uploadedData = ev.target.result; document.getElementById('upFileName').innerText = e.target.files[0].name; document.getElementById('btnSaveUpload').style.display='block'; };
        r.readAsDataURL(e.target.files[0]);
    };
    document.getElementById('btnSaveUpload').onclick = () => {
        const name = document.getElementById('upName').value.trim().toLowerCase();
        if(name && uploadedData) saveRecord(name, uploadedData);
    };

    function saveRecord(name, photo) {
        const tx = db.transaction("students", "readwrite");
        tx.objectStore("students").put({ name, photo });
        tx.oncomplete = () => { updateUI(); showScreen('scrMain'); showUI("Saved!"); };
    }

    document.getElementById('btnExport').onclick = () => {
        db.transaction("students").objectStore("students").getAll().onsuccess = (e) => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(e.target.result)], {type:"application/json"}));
            a.download = "Backup.json"; a.click();
        };
    };

    function updateUI() {
        if(!db) return;
        let count = 0; const list = document.getElementById('nameList'); list.innerHTML = "";
        db.transaction("students").objectStore("students").openCursor().onsuccess = (e) => {
            const cur = e.target.result;
            if (cur) { count++; let o = document.createElement('option'); o.value = cur.value.name; list.appendChild(o); cur.continue(); }
            document.getElementById('dbCount').innerText = `Records: ${count}`;
        };
    }
    
    // --- SERVICE WORKER REGISTRATION ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker registration failed', err));
    });
}

</script>
</body>
</html>

